delete [select id from JBCXM__CTA__c where JBCXM__Account__r.Name like 'Account For Related List'];
//Get the list of customers inthe org - assign 1 CTA per customer
Account acnt=[select id,Name from Account where name ='Account For Related List'];

List<JBCXM__CTATypes__c> ctaTypes=[select id,Name from JBCXM__CTATypes__c];  
//Get the list of CTATypes in the org

List<JBCXM__PickList__c> reason = [SELECT id FROM JBCXM__PickList__c WHERE JBCXM__Category__c = 'Alert Reason'];                        
List<JBCXM__PickList__c> severity = [SELECT id FROM JBCXM__PickList__c WHERE JBCXM__Category__c = 'Alert Severity'];                        
List<JBCXM__PickList__c> status = [SELECT id FROM JBCXM__PickList__c WHERE JBCXM__Category__c = 'Alert Status' and JBCXM__SystemName__c in ('New ','Work In Progress')];
 
User user = [select id,Name from User where Name =: userInfo.getName()];
//Create CTAs - for last 2 quarters
List<JBCXM__CTA__c> ctas= new List<JBCXM__CTA__c>();
integer j=0,k=0,l=0;
for(JBCXM__CTATypes__c ctaType : ctaTypes){
      		ctas.add(new JBCXM__CTA__c(Name=acnt.Name+'-'+ctaType.Name+' CTA ',JBCXM__Account__c=acnt.id,
																JBCXM__Assignee__c=user.Id,JBCXM__CreatedDate__c=system.Date.today()                                       ,JBCXM__Type__c=ctaType.id,JBCXM__DueDate__c=system.Date.today().addDays(5),JBCXM__Priority__c=severity.get(j).id
																,JBCXM__Reason__c=reason.get(k).id,JBCXM__Stage__c=status.get(l).id));   
        if(++j==severity.size()) j=0;
		if(++k == reason.size()) k=0;
		if(++l == status.size()) l=0;     
        }
insert ctas;

//Create Tasks for CTAs 
delete [select id from JBCXM__CSTask__c where JBCXM__Account__r.Name = 'Account For Related List'];

List<JBCXM__CSTask__c> csTasks=new List<JBCXM__CSTask__c>();
List<JBCXM__CTA__c> allCtas=[select id,JBCXM__OpenTaskCount__c,JBCXM__TaskCount__c,JBCXM__Account__c,JBCXM__DueDate__c,Name from JBCXM__CTA__c where JBCXM__Account__r.Name like 'Account For Related List'];
String[] priorities = new String[]{'High','Low','Medium'};
integer userCnt=0;
integer i=0;
for(JBCXM__CTA__c ct : allCtas){
		csTasks.add(new JBCXM__CSTask__c(JBCXM__Account__c=ct.JBCXM__Account__c                                               																							
                                                     ,JBCXM__Assigned__c=user.Id,JBCXM__CTA__c=ct.Id
													,JBCXM__Date__c=ct.JBCXM__DueDate__c.addDays(i)
                                                     ,JBCXM__Description__c='Task'+i+' for CTA '+ct.Name
                                                     ,JBCXM__OriginalDueDate__c=ct.JBCXM__DueDate__c.addDays(i)
                                                     ,JBCXM__Priority__c=priorities[i],JBCXM__Status__c='Open'
                                                     ,JBCXM__Subject__c='Task for CTA '+ct.Name));
			i++;
			ct.JBCXM__TaskCount__c=ct.JBCXM__TaskCount__c+1;
    }
insert csTasks;
upsert allCtas;